<!--
@license
(C) Copyright 2016 Nuxeo SA (http://nuxeo.com/) and others.

Licensed under the Apache License, Version 2.0 (the "License"); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
  Joshua Fletcher <jfletcher@nuxeo.com>
-->
<link rel="import"
    href="../bower_components/polymer/polymer.html">
<link rel="import"
    href="../bower_components/nuxeo-elements/nuxeo-page-provider.html">
<!--
An element to bind a `nuxeo-labs-map-chart` to a Content View fitler widget.

Given a Content View, converts aggregation data to data for the chart.

Example:

    <geomap-content-view-filter-binding provider="myProvider"
                                        parent-doc-id="ac6600c0-beaa-48d7-824d-00374a384213"
                                        aggregate-name="schema_field_1_agg"
                                        data="{{dataForMap}}">
    </geomap-content-view-filter-binding>

@group Nuxeo Geomap Demo Elements
@element geomap-content-view-filter-binding
-->
<dom-module id="geomap-content-view-filter-binding">

  <template>

    <nuxeo-page-provider id="contentViewProvider" provider="[[provider]]"
        aggregations="{{_aggregations}}">
    </nuxeo-page-provider>

  </template>

  <script>
    Polymer({
      is: 'geomap-content-view-filter-binding',

      properties: {
        /**
         * Page provider name.
         * @public
         */
        provider: String,

        /**
         * Document id of the folderish parent for the content view.
         * @public
         */
        parentDocId: String,

        /**
         * This value is generated by Studio for the aggregation contribution
         * but it's also used as the name of the object in the JSON result.
         * @public
         */
        aggregateName: String,

        /**
         * Data suitable for `nuxeo-labs-map-chart`
         * @public
         */
        data: {
          type: Array,
          notify: true
        }

      },

      observers: ['_execute(provider,parentDocId)',
        '_convertAggregationsToMapData(_aggregations)'
      ],



      _convertAggregationsToMapData: function(_aggregations) {
        if (_aggregations &&
          _aggregations[aggregateName] &&
          _aggregations[aggregateName].buckets &&
          _aggregations[aggregateName].buckets.length > 0) {
          var aggregationData = _aggregations[aggregateName].buckets;
          var mapData = aggregationData.map(function(e) {
            var res = [e.key];
            res.push(e.docCount);
            return res;
          });
          mapData.unshift(["Item", "Count"]);
          this.data = mapData;
        }
      },

      _execute: function(provider,parentDocId) {
        // `nuxeo-page-provider` expects an object for the `params` attribute.
        this.$.contentViewProvider.params = [parentDocId];
        this.$.contentViewProvider.fetch();
      }

    });
  </script>

</dom-module>
